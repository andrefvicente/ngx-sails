import { Inject, Injectable, Optional } from '@angular/core';
import { Observable, Subject } from 'rxjs';
import * as _io from 'socket.io-client';
import { SailsError } from './classes/SailsError';
import { SailsResponse } from './classes/SailsResponse';
import { IO_INSTANCE } from './tokens/IO_INSTANCE';
import { NGX_SAILS_CONFIG } from './tokens/NGX_SAILS_CONFIG';
import * as i0 from "@angular/core";
export class SailsClient {
    constructor(inj, io, cfg) {
        const SAILS_IO_SDK_STRING = '__sails_io_sdk';
        const SAILS_IO_SDK = {
            language: 'javascript',
            platform: 'browser',
            version: '1.1.12'
        };
        const query = Object.entries(SAILS_IO_SDK).reduce((acc, [key, value]) => {
            acc[`${SAILS_IO_SDK_STRING}_${key}`] = value;
            return acc;
        }, {});
        if (cfg?.options?.query) {
            Object.assign(query, cfg.options.query);
        }
        this._cfg = {
            transports: ['websocket'],
            ...cfg?.options,
            query
        };
        this.io = io || (_io.default || _io)(cfg?.uri, this._cfg);
        this._defaultHeaders = cfg?.headers || {};
        this._errorsSbj = new Subject();
        this.requestErrors = this._errorsSbj.asObservable();
        this.configuration = Object.freeze({
            headers: this._defaultHeaders,
            options: this._cfg,
        });
    }
    delete(url, opts) {
        return this._sendRequest(url, "delete" /* RequestMethod.DELETE */, undefined, opts);
    }
    /** Emit an event */
    emit(event, ...args) {
        this.io.emit(event, ...args);
    }
    /** Emit an event and wait for a response. */
    emitAndWait(event, ...args) {
        return new Observable(subscriber => {
            this.io.emit(event, ...args, (response) => {
                subscriber.next(response);
                subscriber.complete();
            });
        });
    }
    get(url, opts) {
        return this._sendRequest(url, "get" /* RequestMethod.GET */, undefined, opts);
    }
    head(url, opts) {
        return this._sendRequest(url, "head" /* RequestMethod.HEAD */, undefined, opts);
    }
    /** @inheritDoc */
    ngOnDestroy() {
        this._errorsSbj.complete();
    }
    on(event) {
        return new Observable(subscriber => {
            function next(msg) {
                subscriber.next(msg);
            }
            this.io.on(event, next);
            return () => {
                this.io.off(event, next);
            };
        });
    }
    options(url, opts) {
        return this._sendRequest(url, "options" /* RequestMethod.OPTIONS */, undefined, opts);
    }
    patch(url, body, opts) {
        return this._sendRequest(url, "patch" /* RequestMethod.PATCH */, body, opts);
    }
    post(url, body, opts) {
        return this._sendRequest(url, "post" /* RequestMethod.POST */, body, opts);
    }
    put(url, body, opts) {
        return this._sendRequest(url, "put" /* RequestMethod.PUT */, body, opts);
    }
    _sendRequest(url, method, data, options = {}) {
        return sendRequest(clean({
            data: clean(data),
            headers: clean({ ...this._defaultHeaders, ...options.headers }),
            method,
            params: clean(options.params || options.search || {}),
            url
        }), this.io, this._errorsSbj);
    }
}
SailsClient.ɵfac = i0.ɵɵngDeclareFactory({ minVersion: "12.0.0", version: "15.1.2", ngImport: i0, type: SailsClient, deps: [{ token: i0.Injector }, { token: IO_INSTANCE, optional: true }, { token: NGX_SAILS_CONFIG, optional: true }], target: i0.ɵɵFactoryTarget.Injectable });
SailsClient.ɵprov = i0.ɵɵngDeclareInjectable({ minVersion: "12.0.0", version: "15.1.2", ngImport: i0, type: SailsClient, providedIn: 'root' });
i0.ɵɵngDeclareClassMetadata({ minVersion: "12.0.0", version: "15.1.2", ngImport: i0, type: SailsClient, decorators: [{
            type: Injectable,
            args: [{ providedIn: 'root' }]
        }], ctorParameters: function () { return [{ type: i0.Injector }, { type: undefined, decorators: [{
                    type: Optional
                }, {
                    type: Inject,
                    args: [IO_INSTANCE]
                }] }, { type: undefined, decorators: [{
                    type: Optional
                }, {
                    type: Inject,
                    args: [NGX_SAILS_CONFIG]
                }] }]; } });
function sendRequest(request, io, errors$) {
    const { method } = request;
    request.headers = lowerCaseHeaders(request.headers);
    return new Observable(subscriber => {
        let unsubscribed = false;
        io.emit(method, request, (rawResponse) => {
            if (!unsubscribed) {
                if (rawResponse.statusCode >= 400) {
                    const error = new SailsError(rawResponse, request);
                    errors$.next(error);
                    subscriber.error(error);
                }
                else {
                    try {
                        subscriber.next(new SailsResponse(rawResponse, request));
                        subscriber.complete();
                    }
                    catch (e) {
                        subscriber.error(e);
                    }
                }
            }
        });
        return () => {
            unsubscribed = true;
        };
    });
}
function lowerCaseHeaders(headers) {
    if (headers) {
        let lowercased;
        const out = { ...headers };
        for (const [header, value] of Object.entries(headers)) {
            lowercased = header.toLowerCase();
            if (lowercased !== header) {
                out[lowercased] = value;
                delete out[header];
            }
        }
        return out;
    }
    return headers;
}
function clean(obj) {
    if (obj) {
        const out = { ...obj };
        for (const [key, value] of Object.entries(out)) {
            if (value === undefined) {
                delete out[key];
            }
        }
    }
    return obj;
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiU2FpbHNDbGllbnQuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi8uLi8uLi9wcm9qZWN0cy9uZ3gtc2FpbHMvc3JjL2xpYi9TYWlsc0NsaWVudC50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiQUFBQSxPQUFPLEVBQUMsTUFBTSxFQUFFLFVBQVUsRUFBdUIsUUFBUSxFQUFDLE1BQU0sZUFBZSxDQUFDO0FBQ2hGLE9BQU8sRUFBQyxVQUFVLEVBQUUsT0FBTyxFQUFDLE1BQU0sTUFBTSxDQUFDO0FBQ3pDLE9BQU8sS0FBSyxHQUFHLE1BQU0sa0JBQWtCLENBQUM7QUFDeEMsT0FBTyxFQUFDLFVBQVUsRUFBQyxNQUFNLHNCQUFzQixDQUFDO0FBQ2hELE9BQU8sRUFBQyxhQUFhLEVBQUMsTUFBTSx5QkFBeUIsQ0FBQztBQU90RCxPQUFPLEVBQUMsV0FBVyxFQUFDLE1BQU0sc0JBQXNCLENBQUM7QUFDakQsT0FBTyxFQUFDLGdCQUFnQixFQUFDLE1BQU0sMkJBQTJCLENBQUM7O0FBSTNELE1BQU0sT0FBTyxXQUFXO0lBY3RCLFlBQ0UsR0FBYSxFQUNvQixFQUFjLEVBQ1QsR0FBMEI7UUFFaEUsTUFBTSxtQkFBbUIsR0FBRyxnQkFBZ0IsQ0FBQztRQUM3QyxNQUFNLFlBQVksR0FBYztZQUM5QixRQUFRLEVBQUUsWUFBWTtZQUN0QixRQUFRLEVBQUUsU0FBUztZQUNuQixPQUFPLEVBQUUsUUFBUTtTQUNsQixDQUFDO1FBRUYsTUFBTSxLQUFLLEdBQUcsTUFBTSxDQUFDLE9BQU8sQ0FBQyxZQUFZLENBQUMsQ0FBQyxNQUFNLENBQy9DLENBQUMsR0FBUSxFQUFFLENBQUMsR0FBRyxFQUFFLEtBQUssQ0FBZ0IsRUFBTyxFQUFFO1lBQzdDLEdBQUcsQ0FBQyxHQUFHLG1CQUFtQixJQUFJLEdBQUcsRUFBRSxDQUFDLEdBQUcsS0FBSyxDQUFDO1lBRTdDLE9BQU8sR0FBRyxDQUFDO1FBQ2IsQ0FBQyxFQUNELEVBQUUsQ0FDSCxDQUFDO1FBRUYsSUFBSSxH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QUFHLElBQUksQ0FBQztRQUN0QixDQUFDLENBQUM7SUFDSixDQUFDLENBQUMsQ0FBQztBQUNMLENBQUM7QUFFRCxTQUFTLGdCQUFnQixDQUFDLE9BQW1CO0lBQzNDLElBQUksT0FBTyxFQUFFO1FBQ1gsSUFBSSxVQUFrQixDQUFDO1FBQ3ZCLE1BQU0sR0FBRyxHQUFHLEVBQUMsR0FBRyxPQUFPLEVBQUMsQ0FBQztRQUV6QixLQUFLLE1BQU0sQ0FBQyxNQUFNLEVBQUUsS0FBSyxDQUFDLElBQUksTUFBTSxDQUFDLE9BQU8sQ0FBQyxPQUFPLENBQUMsRUFBRTtZQUNyRCxVQUFVLEdBQUcsTUFBTSxDQUFDLFdBQVcsRUFBRSxDQUFDO1lBQ2xDLElBQUksVUFBVSxLQUFLLE1BQU0sRUFBRTtnQkFDekIsR0FBRyxDQUFDLFVBQVUsQ0FBQyxHQUFHLEtBQUssQ0FBQztnQkFDeEIsT0FBTyxHQUFHLENBQUMsTUFBTSxDQUFDLENBQUM7YUFDcEI7U0FDRjtRQUVELE9BQU8sR0FBRyxDQUFDO0tBQ1o7SUFFRCxPQUFPLE9BQVEsQ0FBQztBQUNsQixDQUFDO0FBRUQsU0FBUyxLQUFLLENBQXNCLEdBQU87SUFDekMsSUFBSSxHQUFHLEVBQUU7UUFDUCxNQUFNLEdBQUcsR0FBRyxFQUFDLEdBQUcsR0FBRyxFQUFDLENBQUM7UUFDckIsS0FBSyxNQUFNLENBQUMsR0FBRyxFQUFFLEtBQUssQ0FBQyxJQUFJLE1BQU0sQ0FBQyxPQUFPLENBQUMsR0FBRyxDQUFDLEVBQUU7WUFDOUMsSUFBSSxLQUFLLEtBQUssU0FBUyxFQUFFO2dCQUN2QixPQUFPLEdBQUcsQ0FBQyxHQUFHLENBQUMsQ0FBQzthQUNqQjtTQUNGO0tBQ0Y7SUFFRCxPQUFPLEdBQUksQ0FBQztBQUNkLENBQUMiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQge0luamVjdCwgSW5qZWN0YWJsZSwgSW5qZWN0b3IsIE9uRGVzdHJveSwgT3B0aW9uYWx9IGZyb20gJ0Bhbmd1bGFyL2NvcmUnO1xuaW1wb3J0IHtPYnNlcnZhYmxlLCBTdWJqZWN0fSBmcm9tICdyeGpzJztcbmltcG9ydCAqIGFzIF9pbyBmcm9tICdzb2NrZXQuaW8tY2xpZW50JztcbmltcG9ydCB7U2FpbHNFcnJvcn0gZnJvbSAnLi9jbGFzc2VzL1NhaWxzRXJyb3InO1xuaW1wb3J0IHtTYWlsc1Jlc3BvbnNlfSBmcm9tICcuL2NsYXNzZXMvU2FpbHNSZXNwb25zZSc7XG5pbXBvcnQge1JlcXVlc3RNZXRob2R9IGZyb20gJy4vZW51bXMvUmVxdWVzdE1ldGhvZCc7XG5pbXBvcnQgdHlwZSB7SVJhd1NhaWxzUmVzcG9uc2V9IGZyb20gJy4vaW50ZXJmYWNlcy9JUmF3U2FpbHNSZXNwb25zZSc7XG5pbXBvcnQgdHlwZSB7SVNhaWxzUmVxdWVzdH0gZnJvbSAnLi9pbnRlcmZhY2VzL0lTYWlsc1JlcXVlc3QnO1xuaW1wb3J0IHR5cGUge0lTYWlsc1JlcXVlc3RPcHRzfSBmcm9tICcuL2ludGVyZmFjZXMvSVNhaWxzUmVxdWVzdE9wdHMnO1xuaW1wb3J0IHR5cGUge0lTYWlsc1Jlc3BvbnNlfSBmcm9tICcuL2ludGVyZmFjZXMvSVNhaWxzUmVzcG9uc2UnO1xuaW1wb3J0IHR5cGUge05neFNhaWxzQ29uZmlnfSBmcm9tICcuL2ludGVyZmFjZXMvTmd4U2FpbHNDb25maWcnO1xuaW1wb3J0IHtJT19JTlNUQU5DRX0gZnJvbSAnLi90b2tlbnMvSU9fSU5TVEFOQ0UnO1xuaW1wb3J0IHtOR1hfU0FJTFNfQ09ORklHfSBmcm9tICcuL3Rva2Vucy9OR1hfU0FJTFNfQ09ORklHJztcbmltcG9ydCB0eXBlIHtBbnlPYmplY3R9IGZyb20gJy4vdXRpbC9BbnlPYmplY3QnO1xuXG5ASW5qZWN0YWJsZSh7cHJvdmlkZWRJbjogJ3Jvb3QnfSlcbmV4cG9ydCBjbGFzcyBTYWlsc0NsaWVudCBpbXBsZW1lbnRzIE9uRGVzdHJveSB7XG5cbiAgcHVibGljIHJlYWRvbmx5IGNvbmZpZ3VyYXRpb246IFJlYWRvbmx5PE5neFNhaWxzQ29uZmlnPjtcblxuICBwdWJsaWMgcmVhZG9ubHkgaW86IFNvY2tldElPQ2xpZW50LlNvY2tldDtcblxuICBwdWJsaWMgcmVhZG9ubHkgcmVxdWVzdEVycm9yczogT2JzZXJ2YWJsZTxTYWlsc0Vycm9yPjtcblxuICBwcml2YXRlIHJlYWRvbmx5IF9jZmc6IFNvY2tldElPQ2xpZW50LkNvbm5lY3RPcHRzO1xuXG4gIHByaXZhdGUgcmVhZG9ubHkgX2RlZmF1bHRIZWFkZXJzOiBBbnlPYmplY3Q7XG5cbiAgcHJpdmF0ZSByZWFkb25seSBfZXJyb3JzU2JqOiBTdWJqZWN0PFNhaWxzRXJyb3I+O1xuXG4gIHB1YmxpYyBjb25zdHJ1Y3RvcihcbiAgICBpbmo6IEluamVjdG9yLFxuICAgIEBPcHRpb25hbCgpIEBJbmplY3QoSU9fSU5TVEFOQ0UpIGlvOiBhbnkgfCBudWxsLFxuICAgIEBPcHRpb25hbCgpIEBJbmplY3QoTkdYX1NBSUxTX0NPTkZJRykgY2ZnOiBOZ3hTYWlsc0NvbmZpZyB8IG51bGwsXG4gICkge1xuICAgIGNvbnN0IFNBSUxTX0lPX1NES19TVFJJTkcgPSAnX19zYWlsc19pb19zZGsnO1xuICAgIGNvbnN0IFNBSUxTX0lPX1NESzogQW55T2JqZWN0ID0ge1xuICAgICAgbGFuZ3VhZ2U6ICdqYXZhc2NyaXB0JyxcbiAgICAgIHBsYXRmb3JtOiAnYnJvd3NlcicsXG4gICAgICB2ZXJzaW9uOiAnMS4xLjEyJ1xuICAgIH07XG5cbiAgICBjb25zdCBxdWVyeSA9IE9iamVjdC5lbnRyaWVzKFNBSUxTX0lPX1NESykucmVkdWNlKFxuICAgICAgKGFjYzogYW55LCBba2V5LCB2YWx1ZV06IFtzdHJpbmcsIGFueV0pOiBhbnkgPT4ge1xuICAgICAgICBhY2NbYCR7U0FJTFNfSU9fU0RLX1NUUklOR31fJHtrZXl9YF0gPSB2YWx1ZTtcblxuICAgICAgICByZXR1cm4gYWNjO1xuICAgICAgfSxcbiAgICAgIHt9XG4gICAgKTtcblxuICAgIGlmIChjZmc/Lm9wdGlvbnM/LnF1ZXJ5KSB7XG4gICAgICBPYmplY3QuYXNzaWduKHF1ZXJ5LCBjZmcub3B0aW9ucy5xdWVyeSk7XG4gICAgfVxuXG4gICAgdGhpcy5fY2ZnID0ge1xuICAgICAgdHJhbnNwb3J0czogWyd3ZWJzb2NrZXQnXSxcbiAgICAgIC4uLmNmZz8ub3B0aW9ucyxcbiAgICAgIHF1ZXJ5XG4gICAgfTtcblxuICAgIHRoaXMuaW8gPSBpbyB8fCAoKChfaW8gYXMgYW55KS5kZWZhdWx0IHx8IF9pbykgYXMgU29ja2V0SU9DbGllbnRTdGF0aWMpKGNmZz8udXJpIGFzIGFueSwgdGhpcy5fY2ZnKTtcbiAgICB0aGlzLl9kZWZhdWx0SGVhZGVycyA9IGNmZz8uaGVhZGVycyB8fCB7fTtcbiAgICB0aGlzLl9lcnJvcnNTYmogPSBuZXcgU3ViamVjdCgpO1xuICAgIHRoaXMucmVxdWVzdEVycm9ycyA9IHRoaXMuX2Vycm9yc1Niai5hc09ic2VydmFibGUoKTtcbiAgICB0aGlzLmNvbmZpZ3VyYXRpb24gPSBPYmplY3QuZnJlZXplPE5neFNhaWxzQ29uZmlnPih7XG4gICAgICBoZWFkZXJzOiB0aGlzLl9kZWZhdWx0SGVhZGVycyxcbiAgICAgIG9wdGlvbnM6IHRoaXMuX2NmZyxcbiAgICB9KTtcbiAgfVxuXG4gIHB1YmxpYyBkZWxldGU8VCA9IGFueT4odXJsOiBzdHJpbmcsIG9wdHM/OiBJU2FpbHNSZXF1ZXN0T3B0cyk6IE9ic2VydmFibGU8SVNhaWxzUmVzcG9uc2U8VD4+IHtcbiAgICByZXR1cm4gdGhpcy5fc2VuZFJlcXVlc3QodXJsLCBSZXF1ZXN0TWV0aG9kLkRFTEVURSwgdW5kZWZpbmVkLCBvcHRzKTtcbiAgfVxuXG4gIC8qKiBFbWl0IGFuIGV2ZW50ICovXG4gIHB1YmxpYyBlbWl0KGV2ZW50OiBzdHJpbmcsIC4uLmFyZ3M6IGFueVtdKTogdm9pZCB7XG4gICAgdGhpcy5pby5lbWl0KGV2ZW50LCAuLi5hcmdzKTtcbiAgfVxuXG4gIC8qKiBFbWl0IGFuIGV2ZW50IGFuZCB3YWl0IGZvciBhIHJlc3BvbnNlLiAqL1xuICBwdWJsaWMgZW1pdEFuZFdhaXQ8VCA9IGFueT4oZXZlbnQ6IHN0cmluZywgLi4uYXJnczogYW55W10pOiBPYnNlcnZhYmxlPFQ+IHtcbiAgICByZXR1cm4gbmV3IE9ic2VydmFibGU8VD4oc3Vic2NyaWJlciA9PiB7XG4gICAgICB0aGlzLmlvLmVtaXQoZXZlbnQsIC4uLmFyZ3MsIChyZXNwb25zZTogYW55KSA9PiB7XG4gICAgICAgIHN1YnNjcmliZXIubmV4dChyZXNwb25zZSk7XG4gICAgICAgIHN1YnNjcmliZXIuY29tcGxldGUoKTtcbiAgICAgIH0pO1xuICAgIH0pO1xuICB9XG5cbiAgcHVibGljIGdldDxUID0gYW55Pih1cmw6IHN0cmluZywgb3B0cz86IElTYWlsc1JlcXVlc3RPcHRzKTogT2JzZXJ2YWJsZTxJU2FpbHNSZXNwb25zZTxUPj4ge1xuICAgIHJldHVybiB0aGlzLl9zZW5kUmVxdWVzdCh1cmwsIFJlcXVlc3RNZXRob2QuR0VULCB1bmRlZmluZWQsIG9wdHMpO1xuICB9XG5cbiAgcHVibGljIGhlYWQ8VCA9IGFueT4odXJsOiBzdHJpbmcsIG9wdHM/OiBJU2FpbHNSZXF1ZXN0T3B0cyk6IE9ic2VydmFibGU8SVNhaWxzUmVzcG9uc2U8VD4+IHtcbiAgICByZXR1cm4gdGhpcy5fc2VuZFJlcXVlc3QodXJsLCBSZXF1ZXN0TWV0aG9kLkhFQUQsIHVuZGVmaW5lZCwgb3B0cyk7XG4gIH1cblxuICAvKiogQGluaGVyaXREb2MgKi9cbiAgcHVibGljIG5nT25EZXN0cm95KCk6IHZvaWQge1xuICAgIHRoaXMuX2Vycm9yc1Niai5jb21wbGV0ZSgpO1xuICB9XG5cbiAgcHVibGljIG9uPFQgPSBhbnk+KGV2ZW50OiBzdHJpbmcpOiBPYnNlcnZhYmxlPFQ+IHtcbiAgICByZXR1cm4gbmV3IE9ic2VydmFibGU8VD4oc3Vic2NyaWJlciA9PiB7XG4gICAgICBmdW5jdGlvbiBuZXh0KG1zZzogYW55KTogdm9pZCB7XG4gICAgICAgIHN1YnNjcmliZXIubmV4dChtc2cpO1xuICAgICAgfVxuXG4gICAgICB0aGlzLmlvLm9uKGV2ZW50LCBuZXh0KTtcblxuICAgICAgcmV0dXJuICgpID0+IHtcbiAgICAgICAgdGhpcy5pby5vZmYoZXZlbnQsIG5leHQpO1xuICAgICAgfTtcbiAgICB9KTtcbiAgfVxuXG4gIHB1YmxpYyBvcHRpb25zPFQgPSBhbnk+KHVybDogc3RyaW5nLCBvcHRzPzogSVNhaWxzUmVxdWVzdE9wdHMpOiBPYnNlcnZhYmxlPElTYWlsc1Jlc3BvbnNlPFQ+PiB7XG4gICAgcmV0dXJuIHRoaXMuX3NlbmRSZXF1ZXN0KHVybCwgUmVxdWVzdE1ldGhvZC5PUFRJT05TLCB1bmRlZmluZWQsIG9wdHMpO1xuICB9XG5cbiAgcHVibGljIHBhdGNoPFQgPSBhbnk+KHVybDogc3RyaW5nLCBib2R5PzogQW55T2JqZWN0LCBvcHRzPzogSVNhaWxzUmVxdWVzdE9wdHMpOiBPYnNlcnZhYmxlPElTYWlsc1Jlc3BvbnNlPFQ+PiB7XG4gICAgcmV0dXJuIHRoaXMuX3NlbmRSZXF1ZXN0KHVybCwgUmVxdWVzdE1ldGhvZC5QQVRDSCwgYm9keSwgb3B0cyk7XG4gIH1cblxuICBwdWJsaWMgcG9zdDxUID0gYW55Pih1cmw6IHN0cmluZywgYm9keT86IEFueU9iamVjdCwgb3B0cz86IElTYWlsc1JlcXVlc3RPcHRzKTogT2JzZXJ2YWJsZTxJU2FpbHNSZXNwb25zZTxUPj4ge1xuICAgIHJldHVybiB0aGlzLl9zZW5kUmVxdWVzdCh1cmwsIFJlcXVlc3RNZXRob2QuUE9TVCwgYm9keSwgb3B0cyk7XG4gIH1cblxuICBwdWJsaWMgcHV0PFQgPSBhbnk+KHVybDogc3RyaW5nLCBib2R5PzogQW55T2JqZWN0LCBvcHRzPzogSVNhaWxzUmVxdWVzdE9wdHMpOiBPYnNlcnZhYmxlPElTYWlsc1Jlc3BvbnNlPFQ+PiB7XG4gICAgcmV0dXJuIHRoaXMuX3NlbmRSZXF1ZXN0KHVybCwgUmVxdWVzdE1ldGhvZC5QVVQsIGJvZHksIG9wdHMpO1xuICB9XG5cbiAgcHJpdmF0ZSBfc2VuZFJlcXVlc3QoXG4gICAgdXJsOiBzdHJpbmcsXG4gICAgbWV0aG9kOiBSZXF1ZXN0TWV0aG9kLFxuICAgIGRhdGE/OiBBbnlPYmplY3QsXG4gICAgb3B0aW9uczogSVNhaWxzUmVxdWVzdE9wdHMgPSB7fVxuICApOiBPYnNlcnZhYmxlPFNhaWxzUmVzcG9uc2U+IHtcbiAgICByZXR1cm4gc2VuZFJlcXVlc3Q8YW55PihcbiAgICAgIGNsZWFuKHtcbiAgICAgICAgZGF0YTogY2xlYW4oZGF0YSksXG4gICAgICAgIGhlYWRlcnM6IGNsZWFuKHsuLi50aGlzLl9kZWZhdWx0SGVhZGVycywgLi4ub3B0aW9ucy5oZWFkZXJzfSksXG4gICAgICAgIG1ldGhvZCxcbiAgICAgICAgcGFyYW1zOiBjbGVhbihvcHRpb25zLnBhcmFtcyB8fCBvcHRpb25zLnNlYXJjaCB8fCB7fSksXG4gICAgICAgIHVybFxuICAgICAgfSksXG4gICAgICB0aGlzLmlvLFxuICAgICAgdGhpcy5fZXJyb3JzU2JqXG4gICAgKTtcbiAgfVxufVxuXG5mdW5jdGlvbiBzZW5kUmVxdWVzdDxUPihcbiAgcmVxdWVzdDogSVNhaWxzUmVxdWVzdCxcbiAgaW86IFNvY2tldElPQ2xpZW50LlNvY2tldCxcbiAgZXJyb3JzJDogU3ViamVjdDxTYWlsc0Vycm9yPlxuKTogT2JzZXJ2YWJsZTxTYWlsc1Jlc3BvbnNlPFQ+PiB7XG4gIGNvbnN0IHttZXRob2R9ID0gcmVxdWVzdDtcbiAgcmVxdWVzdC5oZWFkZXJzID0gbG93ZXJDYXNlSGVhZGVycyhyZXF1ZXN0LmhlYWRlcnMpO1xuXG4gIHJldHVybiBuZXcgT2JzZXJ2YWJsZTxTYWlsc1Jlc3BvbnNlPihzdWJzY3JpYmVyID0+IHtcbiAgICBsZXQgdW5zdWJzY3JpYmVkID0gZmFsc2U7XG5cbiAgICBpby5lbWl0KG1ldGhvZCwgcmVxdWVzdCwgKHJhd1Jlc3BvbnNlOiBJUmF3U2FpbHNSZXNwb25zZSkgPT4ge1xuICAgICAgaWYgKCF1bnN1YnNjcmliZWQpIHtcbiAgICAgICAgaWYgKHJhd1Jlc3BvbnNlLnN0YXR1c0NvZGUgPj0gNDAwKSB7XG4gICAgICAgICAgY29uc3QgZXJyb3IgPSBuZXcgU2FpbHNFcnJvcihyYXdSZXNwb25zZSwgcmVxdWVzdCk7XG4gICAgICAgICAgZXJyb3JzJC5uZXh0KGVycm9yKTtcbiAgICAgICAgICBzdWJzY3JpYmVyLmVycm9yKGVycm9yKTtcbiAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICB0cnkge1xuICAgICAgICAgICAgc3Vic2NyaWJlci5uZXh0KG5ldyBTYWlsc1Jlc3BvbnNlPGFueT4ocmF3UmVzcG9uc2UsIHJlcXVlc3QpKTtcbiAgICAgICAgICAgIHN1YnNjcmliZXIuY29tcGxldGUoKTtcbiAgICAgICAgICB9IGNhdGNoIChlKSB7XG4gICAgICAgICAgICBzdWJzY3JpYmVyLmVycm9yKGUpO1xuICAgICAgICAgIH1cbiAgICAgICAgfVxuICAgICAgfVxuICAgIH0pO1xuXG4gICAgcmV0dXJuICgpID0+IHtcbiAgICAgIHVuc3Vic2NyaWJlZCA9IHRydWU7XG4gICAgfTtcbiAgfSk7XG59XG5cbmZ1bmN0aW9uIGxvd2VyQ2FzZUhlYWRlcnMoaGVhZGVycz86IEFueU9iamVjdCk6IEFueU9iamVjdCB7XG4gIGlmIChoZWFkZXJzKSB7XG4gICAgbGV0IGxvd2VyY2FzZWQ6IHN0cmluZztcbiAgICBjb25zdCBvdXQgPSB7Li4uaGVhZGVyc307XG5cbiAgICBmb3IgKGNvbnN0IFtoZWFkZXIsIHZhbHVlXSBvZiBPYmplY3QuZW50cmllcyhoZWFkZXJzKSkge1xuICAgICAgbG93ZXJjYXNlZCA9IGhlYWRlci50b0xvd2VyQ2FzZSgpO1xuICAgICAgaWYgKGxvd2VyY2FzZWQgIT09IGhlYWRlcikge1xuICAgICAgICBvdXRbbG93ZXJjYXNlZF0gPSB2YWx1ZTtcbiAgICAgICAgZGVsZXRlIG91dFtoZWFkZXJdO1xuICAgICAgfVxuICAgIH1cblxuICAgIHJldHVybiBvdXQ7XG4gIH1cblxuICByZXR1cm4gaGVhZGVycyE7XG59XG5cbmZ1bmN0aW9uIGNsZWFuPFQgZXh0ZW5kcyBBbnlPYmplY3Q+KG9iaj86IFQpOiBUIHtcbiAgaWYgKG9iaikge1xuICAgIGNvbnN0IG91dCA9IHsuLi5vYmp9O1xuICAgIGZvciAoY29uc3QgW2tleSwgdmFsdWVdIG9mIE9iamVjdC5lbnRyaWVzKG91dCkpIHtcbiAgICAgIGlmICh2YWx1ZSA9PT0gdW5kZWZpbmVkKSB7XG4gICAgICAgIGRlbGV0ZSBvdXRba2V5XTtcbiAgICAgIH1cbiAgICB9XG4gIH1cblxuICByZXR1cm4gb2JqITtcbn1cbiJdfQ==